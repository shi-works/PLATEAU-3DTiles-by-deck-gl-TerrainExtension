<!DOCTYPE html>
<html>

<head>
    <title>3D都市モデルPLATEAU 3DTiles+用途地域</title>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/@loaders.gl/3d-tiles@^2.3.0/dist/dist.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #map_credit {
            display: inline-block;
            position: absolute;
            bottom: 0;
            right: 0;
            padding: 0.2em;
            margin: 0;
            background-color: rgba(255, 255, 255, .7);
            font-size: 70%;
            color: black;
            z-index: 10000;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <a id=map_credit href=https://github.com/Project-PLATEAU/plateau-streaming-tutorial>3D都市モデルPLATEAU配信サービス（試験運用）</a>
    <script>
        // GeoJSON
        const data = d3.json('./A29-19_13104.geojson');

        // 環境光
        const ambientLight = new deck.AmbientLight({
            color: [255, 255, 255],
            intensity: 3.0
        });

        // 平行ライト
        const directionalLight = new deck.DirectionalLight({
            color: [255, 255, 255],
            intensity: 9.0,
            direction: [-3, -9, -1]
        });

        // マップの初期化
        const deckgl = new deck.DeckGL({
            container: 'map',
            initialViewState: {
                latitude: 35.68960,
                longitude: 139.7005713,
                zoom: 16,
                bearing: 0,
                pitch: 60,
            },
            controller: { inertia: true },
            effects: [
                new deck.LightingEffect({ ambientLight, directionalLight })
            ],
            layers: [
                new deck.TileLayer({
                    data: "https://gic-plateau.s3.ap-northeast-1.amazonaws.com/2020/ortho/tiles/{z}/{x}/{y}.png",
                    minZoom: 0,
                    maxZoom: 19,
                    tileSize: 256,
                    renderSubLayers: props => new deck.BitmapLayer(props, {
                        data: null,
                        image: props.data,
                        bounds: (({ west, south, east, north }) => [west, south, east, north])(props.tile.bbox),
                    }),
                }),
                new deck.Tile3DLayer({
                    id: "tile3dlayer",
                    data: 'https://plateau.geospatial.jp/main/data/3d-tiles/bldg/13100_tokyo/13104_shinjuku-ku/low_resolution/tileset.json', // 新宿区
                    loader: Tiles3DLoader,
                    opacity: 1,
                    pickable: false,
                    onTileLoad: d => {
                        const { content } = d;
                        const buffer = content.batchTableBinary.buffer;
                        const key = content.batchTableJson;
                        const len = key._gml_id.length;
                        const zMinView = new DataView(buffer, key._zmin.byteOffset, len * 8);
                        const zMins = [];

                        for (let i = 0; i < len; i++) {
                            zMins.push(zMinView.getFloat64(i * 8, true));
                        }
                        zMins.sort((a, b) => a - b);
                        content.cartographicOrigin.z -= 36.9702 + zMins[Math.floor(len / 2)];
                    },
                    operation: 'terrain+draw'
                }),
                new deck.GeoJsonLayer({
                    id: 'youtochiiki',
                    data: data,
                    stroked: false,
                    filled: true,
                    getFillColor: ({ properties }) => {
                        const { A29_004 } = properties;
                        if (A29_004 == 1)
                            return [0, 178, 133]
                        else if (A29_004 == 2)
                            return [145, 207, 185]
                        else if (A29_004 == 3)
                            return [120, 206, 63]
                        else if (A29_004 == 4)
                            return [173, 223, 33]
                        else if (A29_004 == 5)
                            return [235, 238, 94]
                        else if (A29_004 == 6)
                            return [255, 210, 182]
                        else if (A29_004 == 7)
                            return [255, 166, 56]
                        else if (A29_004 == 8)
                            return [255, 176, 195]
                        else if (A29_004 == 9)
                            return [255, 89, 61]
                        else if (A29_004 == 10)
                            return [167, 148, 197]
                        else if (A29_004 == 11)
                            return [185, 234, 255]
                        else if (A29_004 == 12)
                            return [95, 197, 251]
                        else if (A29_004 == 21)
                            return [196, 215, 155]
                    },
                    opacity: 0.4,
                    extensions: [new deck._TerrainExtension()]
                })
            ]
        });
    </script>
</body>

</html>